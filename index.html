<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>NIMIQ.WATCH</title>

    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">

    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Source+Sans+Pro:400,600" rel="stylesheet">
    <style>
        body {
            background: snow;
            color: #042146;
            font-family: "Source Sans Pro", sans-serif;
            font-size: 18px;
            letter-spacing: 0.02em;
            padding: 0;
            margin: 0;
        }

        a {
            color: #042146;
            text-decoration: none;
            border-bottom: 1px dotted;
            position: relative;
        }

        a:hover,
        a:focus {
            border-bottom-style: solid;
        }

        header {
            background: #042146;
            color: white;
            padding: 0.5em 0.8em;
            overflow: visible;
            position: fixed;
            top: 0;
            left: 0;
            box-sizing: border-box;
            width: 100%;
            box-shadow: 0 0 10px 0 black;
            z-index: 1000;
        }

        header h1 {
            margin: 0.1em 0;
            margin-right: 1em;
            float: left;
            font-size: 1.5em;
            letter-spacing: 0.05em;
        }

        header h1 a {
            color: inherit;
            text-decoration: none;
        }

        header .nimiq-logo {
            position: relative;
            top: 0.25em;
        }

        header > a,
        header .submenu-container,
        header .submenu-container > a {
            line-height: 2.7em;
            color: white;
            float: left;
            border: none;
            padding: 0 0.75em;
            margin-right: 0.5em;
            position: relative;
            display: block;
            cursor: pointer;
            border-radius: 3px;
        }

        header a,
        header a:hover,
        header a:focus {
            border: none;
        }

        header > a:hover,
        header > a:focus,
        header > a:target,
        header .submenu-container > a:focus,
        header .submenu-container > a:target {
            background: white;
            color: #042146;
        }

        header .submenu-container {
            padding: 0;
            position: relative;
        }

        header .submenu-container > a {
            margin: 0;
        }

        header .submenu {
            display: none;
            position: absolute;
            top: 100%;
            left: -1px;
            z-index: 1500;
            border-radius: 3px;
        }

        header .submenu-container:hover > a {
            background: white;
            color: #042146;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        header .submenu-container:hover .submenu {
            display: block;
        }

        header .submenu a {
            background: white;
            display: block;
            padding: 0 1em;
            white-space: nowrap;
            border: 1px solid;
            border-top: none;
            line-height: 2.7em;
            padding: 0 0.75em;
        }

        header .submenu a:first-child {
            border-top: 1px solid;
            border-top-right-radius: 3px;
        }

        header .submenu a:last-child {
            border-bottom-left-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        header .submenu a:hover {
            background: #F0F0F0;
        }

        #monitor {
            float: right;
            line-height: 2.7em;
        }

        .not-connected {
            color: red;
        }

        .synchronizing {
            color: gold;
        }

        .consensus-established {
            color: limegreen;
        }

        img.nimiq_currency {
            height: 12px;
        }

        #searchbox {
            max-width: 800px;
            margin: 2em auto;
            padding: 0 20px;
            padding-top: 3.6em;
        }

        #searchbox h1 {
            font-weight: normal;
            text-align: center;
        }

        #search-form input {
            font-size: inherit;
            font-family: "Fira Mono", monospace;
            padding: 1em;
            border-radius: 3px;
            border: 1px solid #042146;
        }

        #search-input {
            width: 83%;
            text-transform: uppercase;
        }

        #search-submit {
            width: 10%;
            text-transform: uppercase;
            cursor: pointer;
            font-weight: bold;
            min-width: 60px;
            background: #DDDDDD;
        }
        #search-submit:hover {
            background: #CCCCCC;
        }
        #search-submit:disabled {
            cursor: progress;
            background: #DDDDDD;
        }

        #search-form .detection {
            font-size: 16px;
        }

        #hash-format {
            font-weight: bold;
            margin-left: 0.2em;
        }

        hash {
            font-family: "Fira Mono", monospace;
            font-size: 16px;
            letter-spacing: -0.04em;
            text-transform: uppercase;
        }

        #infobox {
            width: 900px;
            margin: 4em auto 2em auto;
            padding: 0 20px;
        }

        #infobox h2,
        #infobox h3 {
            font-weight: normal;
            text-transform: uppercase;
            margin-bottom: 0.2em;
        }

        #infobox h2 {
            margin-bottom: 0.4em;
        }

        #infobox h3 {
            font-weight: bold;
            font-size: 16px;
            color: #999;
        }

        #infobox img {
            height: 12px;
        }

        .accountinfo-wrapper {
            width: 410px;
            margin: auto;
        }

        .about-wrapper {
            width: 600px;
            margin: auto;
            padding: 1em;
            background: white;
            border: 1px solid #D9DEE4;
            border-radius: 5px;
        }

        .about-wrapper h2 {
            margin-top: 0;
        }

        .about-wrapper p:last-child {
            margin-bottom: 0;
        }

        .blockinfo-header {
            overflow: auto;
            border: 1px solid #D9DEE4;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            background: #F0F0F0;
        }

        .accountinfo-wrapper .blockinfo-header {
            padding: 2px 1em 1em 1em;
        }

        .blockinfo-header .height {
            float: left;
            width: 200px;
            padding: 0 1em 1em 1em;
            overflow: auto;
        }

        .blockinfo-header .height span {
            font-size: 40px;
            float: left;
        }

        .blockinfo-header .height div {
            float: left;
            margin-left: 0.3em;
        }

        .blockinfo-header .height a {
            display: block;
            border: none;
            opacity: 0.3;
        }

        .blockinfo-header .height a:hover,
        .blockinfo-header .height a:focus {
            opacity: 1;
            /*color: #87cefa;  lightskyblue */
        }

        .blockinfo-header .height a:first-child {
            margin-top: 6px;
            margin-bottom: -6px;
        }

        .blockinfo-header .hash {
            float: left;
        }

        .blockinfo-body {
            overflow: auto;
            border-left: 1px solid #D9DEE4;
            border-right: 1px solid #D9DEE4;
            background: white;
        }

        .accountinfo-wrapper .blockinfo-body {
            padding: 0.25em 1em;
            border-bottom: 1px solid #D9DEE4;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }

        .blockinfo-body-left,
        .blockinfo-body-right {
            float: left;
            width: 50%;
            box-sizing: border-box;
            padding: 0.25em 1em;
        }

        .blockinfo-body-left {
            border-right: 1px solid #D9DEE4;
        }

        .blockinfo-body-row {
            margin: 0.75em 0;
            overflow: auto;
        }

        .blockinfo-body-row label,
        .blockinfo-miner label {
            float: left;
            color: #888;
        }

        .blockinfo-body-row span,
        .blockinfo-miner hash {
            float: right;
        }

        .blockinfo-miner {
            clear: both;
            border-top: 1px solid #D9DEE4;
            padding: 1em;
            overflow: auto;
        }

        .blockinfo-transactions {
            border: 1px solid #D9DEE4;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            padding: 1em;
            background: white;
        }

        .blockinfo-transaction-header-row {
            display: table-row;
        }

        .blockinfo-transaction-header-row h3 {
            display: table-cell;
        }

        .blockinfo-transaction-header-row h3:last-child {
            text-align: right;
        }

        .blockinfo-transaction-row {
            display: table-row;
        }

        .blockinfo-transaction-row > * {
            display: table-cell;
            padding: 0.75em 1em 0 0;
            white-space: nowrap;
        }

        .blockinfo-transaction-row:nth-child(2) > * {
            padding-top: 0.5em;
        }

        .blockinfo-transaction-row > span {
            padding-right: 0;
            width: 100%;
            text-align: right;
        }

        .no-transactions {
            text-align: center;
            text-transform: uppercase;
            color: #AAA;
        }

        #infobox .charts-wrapper {
            background: white;
            width: 400px;
            margin: auto;
            border: 1px solid #D9DEE4;
            border-radius: 5px;
            padding: 1em;
        }

        #infobox .charts-wrapper h2 {
            margin-top: 0;
        }

        #infobox .charts-wrapper p {
            margin-bottom: 0;
        }

        #infobox .charts-wrapper a {
            background: #042146;
            color: white;
            padding: 0 0.75em;
            line-height: 2.5em;
            display: inline-block;
            border-radius: 3px;
            border: 1px solid #042146;
            margin-bottom: 4px;
        }

        #infobox .charts-wrapper a:hover,
        #infobox .charts-wrapper a:focus {
            color: #042146;
            background: white;
        }

        #infobox .axis-type-switch {
            float: right;
            font-size: 16px;
            width: 250px;
            margin-top: 1em;
        }

        #infobox .axis-type-switch label {
            cursor: pointer;
        }

        #infobox .axis-type-switch input:disabled + span {
            cursor: progress;
            opacity: 0.4;
        }

        #infobox .axis-type-switch label span span {
            font-weight: normal;
        }

        #infobox canvas {
            width: 100%;
            height: 450px;
            box-sizing: border-box;
            padding: 1em;
            background: white;
            border: 1px solid #D9DEE4;
            border-radius: 5px;
            clear: both;
        }

        #infobox > small {
            display: block;
            margin-top: -1em;
            margin-bottom: 1em;
            color: #888;
        }

        #infobox > .chart-valid-info {
            text-align: right;
            font-size: smaller;
            color: #888;
            font-style: italic;
        }

        #blocklist-wrapper {
            max-width: 950px;
            margin: 4em auto 2em auto;
            padding: 0 20px;
        }

        #blocklist-wrapper h2 {
            font-weight: normal;
            text-transform: uppercase;
            margin-bottom: 0.2em;
        }

        #blocklist {
            display: table;
            border-spacing: 0 8px;
            width: 100%;
        }

        .blocklist-block {
            display: table-row;
            background: #D6D6D6;
            background: #F0F0F0;
        }

        a.blocklist-cell::after {
            position: absolute;
            left: 20%;
            bottom: 10px;
            width: 60%;
            content: "";
            border-bottom: 1px dotted;
        }

        a.blocklist-cell:hover::after,
        a.blocklist-cell:focus::after {
            border-bottom-style: solid;
        }

        .blocklist-cell {
            display: table-cell;
            padding: 0.6em 1em;
            white-space: nowrap;
            border-top: 1px solid #D9DEE4;
            border-bottom: 1px solid #D9DEE4;
        }
        .blocklist-cell:first-child {
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
            border-left: 1px solid #D9DEE4;
        }
        .blocklist-cell:last-child {
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
            border-right: 1px solid #D9DEE4;
        }

        .blocklist-loader {
            width: 34px;
            height: 30px;

            margin: auto;
            animation: sk-rotateplane 1.2s infinite ease-in-out;
        }

        .blocklist-loader.over-canvas {
            position: relative;
            top: -260px;
        }

        .blocklist-loader-text {
            text-align: center;
            margin-bottom: 0;
        }

        @keyframes sk-rotateplane {
            0%   { transform: perspective(120px) rotateX(0deg) rotateY(0deg); }
            50%  { transform: perspective(120px) rotateX(-180.1deg) rotateY(0deg); }
            100% { transform: perspective(120px) rotateX(-180deg) rotateY(-179.9deg); }
        }

        .ellipsis {
            text-overflow: ellipsis;
            overflow: hidden;
            width: 100%;
            max-width: 1px; /* enables the correct overflow behaviour */
        }

        footer {
            text-align: center;
            font-size: 14px;
            color: #AAA;
            padding: 1em;
        }
        footer a {
            color: #888;
        }
    </style>

    <script type="text/javascript" src="https://cdn.nimiq.com/core/nimiq.js"></script>
    <script>
        function _onConsensusEstablished() {
            $syncPercentage.style.display = "none";
            $status.innerText = 'connected';
            $status.classList.add('consensus-established');
            document.getElementById('search-submit').removeAttribute('disabled');
            document.getElementById('search-submit').removeAttribute('title');

            _buildListOfLatestBlocks();

            if(!window.onhashchange) {
                window.onhashchange = _onHashChange;
                _onHashChange();
            }
        }

        function _onConsensusLost() {
            console.error('Consensus lost');
            $status.innerText = 'consensus lost';
            $status.classList.remove('consensus-established', 'synchronizing');
        }

        function _onHeadChanged() {
            var height = $.blockchain.height;
            $height.innerText = '#' + height;
            if(syncStartHeight !== 0 && syncTargetHeight !== 0)
                $syncPercentage.innerText = " (" + Math.floor((height - syncStartHeight) / (syncTargetHeight - syncStartHeight) * 100) + "%)";

            if(blocklistBuilt) {
                _getBlockInfo($.blockchain.headHash, function(blockInfo) {
                    _addBlockToListOfLatestBlocks(blockInfo);
                });
            }
        }

        function _onPeersChanged() {
            document.getElementById('monitor').setAttribute('title', 'Connected to ' + $.network.peerCount + ' peers');
        }

        Nimiq.init(function($) {
            $status.innerText = 'synchronizing';
            $status.classList.add('synchronizing');

            window.$ = $;

            $.consensus.on('syncing', function(targetHeight) {
                syncTargetHeight = targetHeight;
                syncStartHeight = $.blockchain.head.height;
            });
            $.consensus.on('established', _onConsensusEstablished);
            $.consensus.on('lost', _onConsensusLost);

            $.blockchain.on('head-changed', _onHeadChanged);
            _onHeadChanged();

            $.network.on('peers-changed', _onPeersChanged);

            $.network.connect();
        }, function(error) {
            console.error(error);
            alert(error);
        });

        // Dummy object to prevent JS errors
        window.$ = {
            consensus: {
                established: false
            }
        };
    </script>
    <script src="vendor/tmpl.min.js"></script>
</head>
<body>
    <header>
        <h1>
            <a href="#" onclick="_linkClicked(this, true);">
                <span class="nimiq-logo">
                    <svg fill="#F6AE2D" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
                </span>
                NIMIQ.WATCH
            </a>
        </h1>
        <a href="#search" onclick="_linkClicked(this, true);" id="search">Search</a>
        <div class="submenu-container">
            <a href="#charts" onclick="_linkClicked(this, true);" id="charts">Charts</a>

            <div class="submenu">
                <a href="#chart-wealth-distribution" onclick="_linkClicked(this);">Wealth Distribution</a>
                <a href="#chart-global-hashrate" onclick="_linkClicked(this);">Global Hashrate</a>
                <a href="#chart-transactions-per-block" onclick="_linkClicked(this);">Transactions</a>
            </div>
        </div>
        <a href="#about" onclick="_linkClicked(this, true);" id="about">What is this?</a>
        <span id="monitor" title="Connected to 0 peers">
            <strong>Status:</strong>
            <span id="status" class="not-connected">connecting</span> @ <span id="height"><em>loading</em></span><span id="syncPercentage"></span>
        </span>
    </header>

    <div id="searchbox">
        <h1>Search accounts and blocks:</h1>

        <form action="#search" method="GET" id="search-form">
            <input type="text" id="search-input" placeholder="account address, HEX block hash or block height" onfocus="this.select();" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <input type="submit" id="search-submit" value="go" disabled="" title="Consensus not established">
            <span class="detection">Format detected: <span id="hash-format"><em>none</em></span></span>
        </form>
    </div>

    <div id="infobox">
    </div>

    <div id="blocklist-wrapper">
        <h2>Latest blocks</h2>
        <div id="blocklist">
            <div class="blocklist-block">
                <div class="blocklist-cell">
                    <div class="blocklist-loader">
                        <svg fill="#F6AE2D" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
                    </div>
                    <p class="blocklist-loader-text">Please wait while the blockchain is being synchronized. You can track the progress in the top right corner of the screen.</p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        This web application is built on top of the <a target="_blank" href="https://nimiq.com">Nimiq Blockchain</a>.
        <a target="_blank" href="https://github.com/sisou/nimiq-watch">View Source Code on Github.</a>
    </footer>

    <script type="text/x-tmpl" id="template-block-info">
        <h2>Block Info</h2>
        <div class="blockinfo-header">
            <div class="height">
                <h3>Height</h3>
                <span>#{%=o.height%}</span>
                <div>
                    <a href="#{%=o.height + 1%}">&#9650;</a>
                    <a href="#{%=o.height - 1%}">&#9660;</a>
                </div>
            </div>
            <div class="hash">
                <h3>Hash</h3>
                <hash>{%=o.hash%}</hash>
            </div>
        </div>
        <div class="blockinfo-body">
            <div class="blockinfo-body-left">
                <div class="blockinfo-body-row">
                    <label>Transactions </label>
                    <span>{%=o.transactionCount%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Transaction Value </label>
                    <span><img src="icons/nimiq_blue.svg"> {%=_formatBalance(Nimiq.Policy.satoshisToCoins(o.transactionValue))%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Difficulty </label>
                    <span>{%=(Math.round(o.difficulty * 100) / 100)%}</span>
                </div>
            </div>
            <div class="blockinfo-body-right">
                <div class="blockinfo-body-row">
                    <label>Timestamp </label>
                    <span>{% var date = new Date(o.timestamp * 1000); print(date.toLocaleString()); %}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Size </label>
                    <span>{%=o.serializedSize%} Bytes</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Nonce </label>
                    <span>{%=o.nonce%}</span>
                </div>
            </div>
            <div class="blockinfo-miner">
                <label>Mined by </label>
                <hash><a href="#{%=o.minerAddr%}" onclick="_linkClicked(this);">{%=o.minerAddr%}</a></hash>
                <!--
                <label>Previous Block </label>
                <hash>{%=o.prevHash%}</hash>
                -->
            </div>
        </div>
        <div class="blockinfo-transactions">
            {% if(o.transactionCount) { %}
                <div class="blockinfo-transaction-header-row">
                    <h3>Sender</h3>
                    <h3>Receiver</h3>
                    <h3>Value</h3>
                </div>
                {% for(var i = 0; i < o.transactions.length; i++) { %}
                    <div class="blockinfo-transaction-row">
                        <hash id="{% var elementId = 'sender-address-' + i; _getAndWriteSenderAddressHash(o.transactions[i], elementId); print(elementId); %}"></hash>
                        <hash><a href="#{%=o.transactions[i].recipientAddr.toHex()%}" onclick="_linkClicked(this);">{%=o.transactions[i].recipientAddr.toHex()%}</a></hash>
                        <span><img src="icons/nimiq_blue.svg"> {%=_formatBalance(Nimiq.Policy.satoshisToCoins(o.transactions[i].value))%}</span>
                    </div>
                {% } %}
            {% } else { %}
                <div class="no-transactions">No transactions</div>
            {% } %}
        </div>
    </script>

    <script type="text/x-tmpl" id="template-account-info">
        <div class="accountinfo-wrapper">
            <h2>Account Info</h2>
            <div class="blockinfo-header">
                <div class="hash">
                    <h3>Address</h3>
                    <hash>{%=o.hash%}</hash>
                </div>
            </div>
            <div class="blockinfo-body">
                <div class="blockinfo-body-row">
                    <label>Balance </label>
                    <span><img src="icons/nimiq_blue.svg"> {%=_formatBalance(Nimiq.Policy.satoshisToCoins(o.balance))%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Nonce </label>
                    <span>{%=o.nonce%}</span>
                </div>
            </div>
        </div>
    </script>

    <script type="text/x-tmpl" id="template-blocklist-block">
        <a href="#{%=o.height%}" class="blocklist-cell" onclick="_linkClicked(this);">
            #{%=o.height%}
        </a>
        <div class="blocklist-cell">
            {% var time = new Date(o.timestamp * 1000); print(time.toLocaleTimeString()); %}
        </div>
        <div class="blocklist-cell">
            {%=o.transactionCount%} {% if(o.transactionCount === 1) print('transaction'); else print('transactions'); %}
        </div>
        <div class="blocklist-cell ellipsis">
            found by <hash><a href="#{%=o.minerAddr%}" onclick="_linkClicked(this);">{%=o.minerAddr%}</a></hash>
        </div>
        <div class="blocklist-cell">
            {%=o.serializedSize%} Bytes
        </div>
    </script>

    <script type="text/x-tmpl" id="template-about">
        <div class="about-wrapper">
            <h2>What is this?</h2>
            <p>
                This website is a blockchain explorer for the new <a href="https://nimiq.com" target="_blank">Nimiq blockchain project</a>.
            </p>
            <p>
                Because the Nimiq blockchain lives in your browser, this website works without a server. All necessary information is
                present in the blockchain, loaded in this browser.
            </p>
            <p>
                The source code for this website is open source and available at
                <a href="https://github.com/sisou/nimiq-watch" target="_blank">https://github.com/sisou/nimiq-watch</a>.
            </p>
            <p>
                To learn more about the Nimiq blockchain, visit the
                <a href="https://nimiq.com"                            target="_blank">homepage</a>,
                check out @nimiqnetwork on
                <a href="https://twitter.com/nimiqnetwork"             target="_blank">Twitter</a> or
                <a href="https://medium.com/nimiq-network"             target="_blank">Medium</a> and join the
                <a href="https://nimiq-slackin.herokuapp.com/"         target="_blank">Slack</a> and
                <a href="https://t.me/joinchat/AAAAAEJW-ozFwo7Er9jpHw" target="_blank">Telegram</a> channels.
            </p>
        </div>
    </script>

    <script type="text/x-tmpl" id="template-charts">
        <div class="charts-wrapper">
            <h2>Charts</h2>
            <p>
                <a href="#chart-wealth-distribution">Wealth Distribution</a>
                <a href="#chart-global-hashrate">Global Hashrate</a>
                <a href="#chart-transactions-per-block">Transactions</a>
            </p>
        </div>
    </script>

    <script type="text/x-tmpl" id="template-wealth-distribution-chart">
        <div class="axis-type-switch">
            <label class="switch-light switch-candy" onclick="">
                <input type="checkbox" onchange="_wealthDistributionSwitchScale(this);" disabled="">
                <span>
                    <span>Linear</span>
                    <span>Logarithmic</span>
                    <a></a>
                </span>
            </label>
        </div>
        <h2>Wealth Distribution</h2>
        <small>Among non-zero accounts</small>
        <canvas class="chart"></canvas>
        <div class="blocklist-loader over-canvas">
            <svg fill="#F6AE2D" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
        </div>
        <div class="chart-valid-info"></div>
    </script>

    <script type="text/x-tmpl" id="template-global-hashrate-chart">
        <h2>Global Hashrate</h2>
        <small>During the last 24 hours</small>
        <canvas class="chart"></canvas>
        <div class="blocklist-loader over-canvas">
            <svg fill="#F6AE2D" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
        </div>
        <div class="chart-valid-info"></div>
        <p><small><strong>Disclaimer:</strong> The global hashrate is estimated every 10 blocks by how fast the last 10 blocks have been mined.
        This time is measured from the timestamps of the blocks. Since the betanet does not yet include time synchronization, each block is timestamped with
        the local system time of the miner. These times can be different from the real time, thus skewing the global hashrate estimation.</small></p>
    </script>

    <script type="text/x-tmpl" id="template-transactions-per-block-chart">
        <h2>Transactions</h2>
        <small>During the last 24 hours</small>
        <canvas class="chart"></canvas>
        <div class="blocklist-loader over-canvas">
            <svg fill="#F6AE2D" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
        </div>
        <div class="chart-valid-info"></div>
    </script>

    <script>
        var accountHashRegExp = new RegExp('^[A-Fa-f0-9]{40}$'),
            blockHashRegExp   = new RegExp('^[A-Fa-f0-9]{64}$');

        var tmpl = {
            blocklistBlock:            tmpl('template-blocklist-block'),
            blockInfo:                 tmpl('template-block-info'),
            accountInfo:               tmpl('template-account-info'),
            about:                     tmpl('template-about'),
            charts:                    tmpl('template-charts'),
            wealthDistributionChart:   tmpl('template-wealth-distribution-chart'),
            globalHashrateChart:       tmpl('template-global-hashrate-chart'),
            transactionsPerBlockChart: tmpl('template-transactions-per-block-chart')
        };

        var $infobox        = document.getElementById('infobox'),
            $searchInput    = document.getElementById('search-input'),
            $status         = document.getElementById('status'),
            $height         = document.getElementById('height'),
            $syncPercentage = document.getElementById('syncPercentage');

        var directNavigationTargets = ['#search', '#charts', '#about'];
        var syncTargetHeight = 0,
            syncStartHeight  = 0;

        function _detectHashFormat(value) {
            if(accountHashRegExp.test(value)) {
                return "Account Address";
            }
            else if(blockHashRegExp.test(value) && value[0] === "0" && value[1] === "0") {
                return "Block Hash";
            }
            else if(value.match(/^[0-9]*$/) && parseInt(value)) {
                return "Block Number";
            }
        }

        function _formatBalance(value) {
            // If the value has no decimal places below 0.01, display 0 decimals
            if(parseFloat(value.toFixed(2)) === value) {
                return value.toFixed(2);
            }
            // Otherwise, all required decimals will be displayed automatically
            else return value;
        }

        function _getBlockInfo(hash, callback) {
            if(typeof hash === "string") {
                hash = Nimiq.Hash.fromHex(hash);
            }

            $.blockchain.getBlock(hash).then(function(block) {
                if(!block) {
                    callback(null);
                    return;
                }

                callback({
                    hash:             hash.toHex(),
                    height:           block.height,
                    timestamp:        block.timestamp,
                    difficulty:       block.difficulty,
                    serializedSize:   block.serializedSize,
                    minerAddr:        block.minerAddr.toHex(),
                    transactionCount: block.transactionCount,
                    transactions:     block.transactions,
                    transactionValue: block.transactions.reduce(function(acc, tx) { return tx.value + acc; }, 0),
                    prevHash:         block.prevHash.toHex(),
                    nonce:            block.nonce
                });
            });
        }

        function _getAndWriteSenderAddressHash(tx, elementId) {
            tx.getSenderAddr().then(function(address) {
                document.getElementById(elementId).innerHTML = '<a href="#' + address.toHex() + '" onclick="_linkClicked(this);">' + address.toHex() + '</a>';
            });
        }

        var blocklistBuilt = false;
        var latestBlocks = [];

        function _buildListOfLatestBlocks() {
            if(blocklistBuilt !== false) return;
            blocklistBuilt = null;

            var _accumulateBlocks = function(blockInfo) {
                latestBlocks.push(blockInfo);

                if(latestBlocks.length === 20) {
                    latestBlocks.sort(function(a, b) {
                        if(a.height < b.height) return -1;
                        else return 1;
                    });

                    blocklistNode.removeChild(blocklistNode.getElementsByTagName('div')[0]);

                    for(var i = 0; i < latestBlocks.length; i++ ) {
                        _addBlockToListOfLatestBlocks(latestBlocks[i]);
                    }

                    latestBlocks = null;
                    blocklistBuilt = true;
                }
            };

            var hashes = $.blockchain.path.slice(-20);

            // Query all blocks' info
            for(var i = 0; i < hashes.length; i++) {
                _getBlockInfo(hashes[i], _accumulateBlocks);
            }
        }

        var blocklistNode = document.getElementById('blocklist');

        function _addBlockToListOfLatestBlocks(blockInfo) {
            var item = document.createElement('div');
            item.classList.add('blocklist-block');

            item.innerHTML = tmpl.blocklistBlock(blockInfo);

            blocklistNode.insertBefore(item, blocklistNode.firstChild);
        }

        function _onHashChange(e) {
            var value = window.location.hash;

            // Remove leading '#'
            if(value[0] === "#") value = value.substring(1);

            if(value === "" || value === "search") {
                // Display homepage
                $infobox.innerText = "";
                $searchInput.value = "";
                $searchInput.focus();
                window.scrollTo(0, 0);
            }
            else if(value === "about") {
                $infobox.innerHTML = tmpl.about();
                window.scrollTo(0, $infobox.offsetTop - 100);
            }
            else if(value === "charts") {
                $infobox.innerHTML = tmpl.charts();
                window.scrollTo(0, $infobox.offsetTop - 100);
            }
            else if(value === "chart-wealth-distribution") {
                _wealthDistribution();
            }
            else if(value === "chart-global-hashrate") {
                _globalHashrate();
            }
            else if(value === "chart-transactions-per-block") {
                _transactionsPerBlock();
            }
            else {
                var format = _detectHashFormat(value);

                $searchInput.value = value;

                switch(format) {
                    case "Account Address":
                        $.accounts.getBalance(Nimiq.Address.fromHex(value)).then(function(balance) {
                            var accountInfo = {
                                hash: value,
                                balance: balance.value,
                                nonce: balance.nonce
                            };

                            $infobox.innerHTML = tmpl.accountInfo(accountInfo);
                            window.scrollTo(0, $infobox.offsetTop - 100);
                        });
                        break;
                    case "Block Hash":
                        _getBlockInfo(value, function(blockInfo) {
                            if(!blockInfo) {
                                alert("That block cannot be found. It my be out of reach due to the temporary checkpoint solution. Lowest possible block: " + $.blockchain.path[0].toHex());
                                return;
                            }

                            $infobox.innerHTML = tmpl.blockInfo(blockInfo);
                            window.scrollTo(0, $infobox.offsetTop - 100);
                        });
                        break;
                    case "Block Number":
                        var currentHeight = $.blockchain.head.height;
                        var pathIndex     = value - currentHeight - 1; // Should be a negative number

                        if(pathIndex < -$.blockchain.path.length) {
                            alert("That block is out of reach due to the temporary checkpoint solution. Lowest possible block: " + $.blockchain.path[0].toHex());
                            return;
                        }
                        if(pathIndex > -1) {
                            alert("That block has not been mined yet.");
                            return;
                        }

                        var blockHash = $.blockchain.path.slice(pathIndex)[0];

                        _getBlockInfo(blockHash, function(blockInfo) {
                            if(!blockInfo) {
                                alert("Cannot find block.");
                                return;
                            }
                            // console.log(blockInfo);

                            $infobox.innerHTML = tmpl.blockInfo(blockInfo);
                            window.scrollTo(0, $infobox.offsetTop - 100);
                        });
                        break;
                    default:
                        alert("Format cannot be detected.");
                }
            }
        }

        $searchInput.addEventListener('input', function(e) {
            document.getElementById('hash-format').innerHTML = _detectHashFormat(this.value) || "<em>none</em>";
        });

        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();

            if(!$.consensus.established) return;

            var value = $searchInput.value;

            if(window.location.hash === "#" + value) {
                // The hashchange event does not trigger if the hash does not change
                // Thus we manually trigger the function
                window.onhashchange();
            }

            window.location.hash = "#" + value;
        });

        function _linkClicked(self, skipReadyCheck) {
            if(!$.consensus.established) {
                if(!skipReadyCheck) {
                    return;
                }
                else {
                    window.location.hash = self.hash;
                    _onHashChange();
                    return;
                }
            }

            if(window.location.hash === self.hash) {
                console.log("_linkClicked triggered");
                _onHashChange();
            }
        }

        $searchInput.focus();
        if(directNavigationTargets.indexOf(window.location.hash) > -1) _onHashChange();
    </script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-101611099-1', 'auto');
        ga('send', 'pageview');
    </script>

    <script>
        async function _wealthDistribution(axisType = "linear", skipRender = false) {
            if(!document.getElementById('toggle-switch-css-link')) {
                if(document.createStyleSheet) {
                    document.createStyleSheet("https://cdn.jsdelivr.net/css-toggle-switch/latest/toggle-switch.css");
                }
                else {
                    var linkTag = document.createElement('link');
                    linkTag.rel = "stylesheet";
                    linkTag.href = "https://cdn.jsdelivr.net/css-toggle-switch/latest/toggle-switch.css";
                    linkTag.id = "toggle-switch-css-link";
                    document.head.appendChild(linkTag);
                }
            }

            if(!skipRender) {
                // Only replace infobox contents when not coming from the scale toggle
                $infobox.innerHTML = tmpl.wealthDistributionChart();
                window.scrollTo(0, $infobox.offsetTop - 100);
            }

            var rootKey  = await $.accounts._tree._store.getRootKey();
            var rootNode = await $.accounts._tree._store.get(rootKey);

            var balances = [];

            await _resolveAccountsTreeNode(rootNode, "", balances);

            balances = balances.filter(balance => balance);
            balances.sort((a, b) => a > b ? -1 : a < b ? 1 : 0);

            balances = balances.map(balance => Nimiq.Policy.satoshisToCoins(balance));

            var _renderWealthDisributionChart = function() {
                var labels = [];
                for (var i = 1; i <= balances.length; i++) { labels.push(i); }
                labels = labels.map(label => label + '.');

                try {
                    $infobox.removeChild($infobox.getElementsByClassName('blocklist-loader')[0]);
                }
                catch(e) {}

                var time = new Date($.blockchain.head.timestamp * 1000);
                $infobox.getElementsByClassName('chart-valid-info')[0].innerHTML = "Created at block #" + $.blockchain.head.height + " - " + time.toLocaleString()

                if(window.chart) window.chart.destroy();

                var ctx = $infobox.getElementsByTagName('canvas')[0].getContext('2d');

                window.chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'line',

                    // The data for our dataset
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "BetaNIM",
                            pointBackgroundColor: '#042146',
                            borderColor: '#042146',
                            data: balances
                        }]
                    },

                    // Configuration options go here
                    options: {
                        animation: {
                            duration: 0
                        },
                        legend: {
                            display: false
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    callback: (value) => {
                                        if(axisType === "linear") {
                                            return value;
                                        }
                                        else if(axisType === "logarithmic") {
                                            // let blockRewardInNim = Nimiq.Policy.BLOCK_REWARD / Nimiq.Policy.SATOSHIS_PER_COIN;

                                            let label = Math.round(parseFloat(value) * Nimiq.Policy.SATOSHIS_PER_COIN) / Nimiq.Policy.SATOSHIS_PER_COIN;

                                            if(label.toString()[0] !== "1" && label.toString().slice(-1) !== "1") return null;

                                            return label;
                                        }
                                    }
                                },
                                type: axisType,
                                scaleLabel: {
                                    display: true,
                                    labelString: "Balance in NIM",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            }],
                            xAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: "Accounts (ordered by balance)",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            }]
                        }
                    }
                });

                $infobox.getElementsByTagName('input')[0].removeAttribute('disabled');
            };

            if(document.getElementById('chart-js-script')) {
                _renderWealthDisributionChart();
            }
            else {
                var scriptTag = document.createElement('script');
                scriptTag.id = "chart-js-script";
                scriptTag.src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js";
                scriptTag.onload = _renderWealthDisributionChart;
                document.body.appendChild(scriptTag);
            }
        }

        async function _resolveAccountsTreeNode(currentNode, currentPrefix, balances) {
            if(!currentNode) return;

            currentPrefix += currentNode.prefix;
            if (currentNode.isTerminal()) {
                balances.push(currentNode.account.balance.value);
            }
            else {
                for (const childKey of currentNode.getChildren()) {
                    const node = await $.accounts._tree._store.get(childKey);
                    await _resolveAccountsTreeNode(node, currentPrefix, balances);
                }
            }
        }

        function _wealthDistributionSwitchScale(self) {
            if(self.checked) {
                _wealthDistribution("logarithmic", true);
            }
            else {
                _wealthDistribution("linear", true);
            }
        }
    </script>
    <script>
        async function _globalHashrate() {
            $infobox.innerHTML = tmpl.globalHashrateChart();
            window.scrollTo(0, $infobox.offsetTop - 100);

            // Analyze available path from the beginning, check when difficulty changes
            var difficulty = [];
            var timestamp  = [];

            for(var i = 0; i < $.blockchain.path.length; i += Nimiq.Policy.DIFFICULTY_ADJUSTMENT_BLOCKS) {
                const block = await $.blockchain.getBlock($.blockchain.path[i]);

                // Set start time to 24h ago
                var startTime = Math.round(Date.now() / 1000) - 60 * 60 * 24;

                if(block.timestamp >= startTime) {
                    difficulty.push(block.difficulty);
                    timestamp.push(block.timestamp);
                }
            }

            // const months = [null, "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            // Calculate hashrate from difficulty
            var hashrate  = difficulty.map(diff => Math.round(diff * Math.pow(2, 16) / Nimiq.Policy.BLOCK_TIME));
            var timelabel = timestamp.map(time => {
                let date = new Date(time * 1000);
                return /*date.getDate() + ". " + months[date.getMonth()] + " " + */date.toTimeString().slice(0, 5);
            });

            var _renderGlobalHashrateChart = function() {
                try {
                    $infobox.removeChild($infobox.getElementsByClassName('blocklist-loader')[0]);
                }
                catch(e) {}

                var time = new Date($.blockchain.head.timestamp * 1000);
                $infobox.getElementsByClassName('chart-valid-info')[0].innerHTML = "Created at block #" + $.blockchain.head.height + " - " + time.toLocaleString()

                if(window.chart) window.chart.destroy();

                var ctx = $infobox.getElementsByTagName('canvas')[0].getContext('2d');

                window.chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'line',

                    // The data for our dataset
                    data: {
                        labels: timelabel,
                        datasets: [{
                            label: "Global hashrate",
                            pointBackgroundColor: '#042146',
                            borderColor: '#042146',
                            data: hashrate,
                            steppedLine: 'after'
                        }]
                    },

                    // Configuration options go here
                    options: {
                        legend: {
                            display: false
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    callback: _humanReadableHashesPerSecond
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: "Hashrate",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            }]
                        },
                        tooltips: {
                            callbacks: {
                                label: _humanReadableHashesPerSecond
                            }
                        }
                    }
                });
            };

            if(document.getElementById('chart-js-script')) {
                _renderGlobalHashrateChart();
            }
            else {
                var scriptTag = document.createElement('script');
                scriptTag.id = "chart-js-script";
                scriptTag.src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js";
                scriptTag.onload = _renderGlobalHashrateChart;
                document.body.appendChild(scriptTag);
            }
        }

        function _humanReadableHashesPerSecond(arg1, arg2) {
            if(typeof arg1 === "number")
                value = arg1;
            else
                value = arg1.yLabel;

            var resultValue = 0;
            var resultUnit = "H/s";

            if(value < 1000) {
                resultValue = value;
            }
            else {
                let kilo = value / 1000;
                if(kilo < 1000) {
                    resultValue = kilo;
                    resultUnit = "kH/s";
                }
                else {
                    let mega = kilo / 1000;
                    if(mega < 1000) {
                        resultValue = mega;
                        resultUnit = "MH/s";
                    }
                    else {
                        resultValue = mega / 1000;
                        resultUnit = "GH/s";
                    }
                }
            }

            if(arg2) {
                resultValue = Math.round(resultValue * 100) / 100;
            }

            return resultValue + " " + resultUnit;
        }
    </script>
    <script>
        async function _transactionsPerBlock() {
            $infobox.innerHTML = tmpl.transactionsPerBlockChart();
            window.scrollTo(0, $infobox.offsetTop - 100);

            var transactionCount = [],
                transactionValue = [],
                height           = [];

            var countAcc = 0,
                valueAcc = 0,
                counter  = 0;

            for(var i = 0; i < $.blockchain.path.length; i++) {
                const block = await $.blockchain.getBlock($.blockchain.path[i]);

                // Set start time to 24h ago
                var startTime = Math.round(Date.now() / 1000) - 60 * 60 * 24;

                if(block.timestamp >= startTime) {
                    counter++;

                    countAcc += block.transactionCount;
                    valueAcc += block.transactions.reduce(function(acc, tx) { return tx.value + acc; }, 0);

                    if(counter >= 10) {
                        transactionCount.push(countAcc);
                        transactionValue.push(valueAcc);
                        height.push((block.height - counter + 1) + "-" + block.height);

                        countAcc = 0;
                        valueAcc = 0;
                        counter  = 0;
                    }
                }
            }

            if(counter > 0) {
                transactionCount.push(countAcc);
                transactionValue.push(valueAcc);
                height.push(($.blockchain.height - counter + 1) + "-" + $.blockchain.height);
            }

            transactionValue = transactionValue.map(value => Nimiq.Policy.satoshisToCoins(value));

            var _renderTransactionsPerBlockChart = function() {
                try {
                    $infobox.removeChild($infobox.getElementsByClassName('blocklist-loader')[0]);
                }
                catch(e) {}

                var time = new Date($.blockchain.head.timestamp * 1000);
                $infobox.getElementsByClassName('chart-valid-info')[0].innerHTML = "Created at block #" + $.blockchain.head.height + " - " + time.toLocaleString()

                if(window.chart) window.chart.destroy();

                var ctx = $infobox.getElementsByTagName('canvas')[0].getContext('2d');

                window.chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'bar',

                    // The data for our dataset
                    data: {
                        labels: height,
                        datasets: [
                        {
                            label: "Transaction Volume",
                            backgroundColor: '#F6AE2D',
                            pointBackgroundColor: 'transparent',
                            borderColor: '#F6AE2D',
                            pointRadius: 3,
                            borderWidth: 2,
                            fill: false,
                            data: transactionValue,
                            type: 'line',
                            yAxisID: 'transactionValue'
                        },
                        {
                            label: "Transactions",
                            backgroundColor: '#042146',
                            borderColor: '#042146',
                            data: transactionCount,
                            yAxisID: 'transactionCount'
                        }]
                    },

                    // Configuration options go here
                    options: {
                        legend: {
                            // display: false
                            reverse: true,
                            labels: {
                                fontFamily: "'Source Sans Pro', sans-serif",
                                fontSize: 16,
                                boxWidth: 16
                            }
                        },
                        scales: {
                            yAxes: [{
                                id: 'transactionCount',
                                position: 'left',
                                scaleLabel: {
                                    display: true,
                                    labelString: "Transactions",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            },
                            {
                                id: 'transactionValue',
                                position: 'right',
                                scaleLabel: {
                                    display: true,
                                    labelString: "Transaction Volume",
                                    fontFamily: "'Source Sans Pro', sans-serif",
                                    fontSize: 16
                                }
                            }]
                        }
                    }
                });
            };

            if(document.getElementById('chart-js-script')) {
                _renderTransactionsPerBlockChart();
            }
            else {
                var scriptTag = document.createElement('script');
                scriptTag.id = "chart-js-script";
                scriptTag.src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js";
                scriptTag.onload = _renderTransactionsPerBlockChart;
                document.body.appendChild(scriptTag);
            }
        }
    </script>
</body>
</html>
