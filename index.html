<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>NIMIQ.WATCH</title>

    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">

    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Source+Sans+Pro:400,600" rel="stylesheet">
    <style>
        body {
            background: snow;
            color: #042146;
            font-family: "Source Sans Pro", sans-serif;
            font-size: 18px;
            letter-spacing: 0.02em;
            padding: 0;
            margin: 0;
        }

        a {
            color: #042146;
            text-decoration: none;
            border-bottom: 1px dotted;
            position: relative;
        }

        a:hover,
        a:focus {
            border-bottom-style: solid;
        }

        header {
            background: #042146;
            color: white;
            padding: 0.5em 0.8em;
            overflow: auto;
            position: fixed;
            top: 0;
            left: 0;
            box-sizing: border-box;
            width: 100%;
            box-shadow: 0 0 10px 0 black;
            z-index: 1000;
        }

        header h1 {
            margin: 0.2em 0;
            margin-right: 1em;
            float: left;
            font-size: 1.5em;
            letter-spacing: 0.05em;
        }

        header h1 a {
            color: inherit;
            text-decoration: none;
            border-bottom: none;
        }

        header h1 a:hover,
        header h1 a:focus {
            border-bottom: none;
        }

        header .nimiq-logo {
            position: relative;
            top: 0.2em;
        }

        header > a {
            line-height: 2.7em;
            color: white;
            float: left;
            border: none;
            padding: 0 1em;
        }

        header > a:hover,
        header > a:focus {
            border: none;
        }

        #monitor {
            float: right;
            line-height: 2.7em;
        }

        .not-connected {
            color: red;
        }

        .synchronizing {
            color: gold;
        }

        .consensus-established {
            color: limegreen;
        }

        img.nimiq_currency {
            height: 12px;
        }

        #search {
            max-width: 800px;
            margin: 2em auto;
            padding: 0 20px;
            padding-top: 3.6em;
        }

        #search h1 {
            font-weight: normal;
            text-align: center;
        }

        #search-form input {
            font-size: inherit;
            font-family: "Fira Mono", monospace;
            padding: 1em;
            border-radius: 3px;
            border: 1px solid #042146;
        }

        #search-input {
            width: 83%;
            text-transform: uppercase;
        }

        #search-submit {
            width: 10%;
            text-transform: uppercase;
            cursor: pointer;
            font-weight: bold;
            min-width: 60px;
        }
        #search-submit:disabled {
            cursor: auto;
        }

        #search-form .detection {
            font-size: 16px;
        }

        #hash-format {
            font-weight: bold;
            margin-left: 0.2em;
        }

        hash {
            font-family: "Fira Mono", monospace;
            font-size: 16px;
            letter-spacing: -0.02em;
            text-transform: uppercase;
        }

        #infobox {
            width: 900px;
            margin: 4em auto 2em auto;
            padding: 0 20px;
        }

        #infobox h2,
        #infobox h3 {
            font-weight: normal;
            text-transform: uppercase;
            margin-bottom: 0.2em;
        }

        #infobox h2 {
            margin-bottom: 0.4em;
        }

        #infobox h3 {
            font-weight: bold;
            font-size: 16px;
            color: #999;
        }

        #infobox img {
            height: 12px;
        }

        .accountinfo-wrapper {
            width: 410px;
            margin: auto;
        }

        .about-wrapper {
            width: 600px;
            margin: auto;
            padding: 1em;
            background: white;
            border: 1px solid #D9DEE4;
            border-radius: 5px;
        }

        .about-wrapper h2 {
            margin-top: 0;
        }

        .about-wrapper p:last-child {
            margin-bottom: 0;
        }

        .blockinfo-header {
            overflow: auto;
            border: 1px solid #D9DEE4;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            background: #F0F0F0;
        }

        .accountinfo-wrapper .blockinfo-header {
            padding: 2px 1em 1em 1em;
        }

        .blockinfo-header .height {
            float: left;
            width: 200px;
            padding: 0 1em 1em 1em;
        }

        .blockinfo-header .height span {
            font-size: 40px;
        }

        .blockinfo-header .hash {
            float: left;
        }

        .blockinfo-body {
            overflow: auto;
            border-left: 1px solid #D9DEE4;
            border-right: 1px solid #D9DEE4;
            background: white;
        }

        .accountinfo-wrapper .blockinfo-body {
            padding: 0.25em 1em;
            border-bottom: 1px solid #D9DEE4;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }

        .blockinfo-body-left,
        .blockinfo-body-right {
            float: left;
            width: 50%;
            box-sizing: border-box;
            padding: 0.25em 1em;
        }

        .blockinfo-body-left {
            border-right: 1px solid #D9DEE4;
        }

        .blockinfo-body-row {
            margin: 0.75em 0;
            overflow: auto;
        }

        .blockinfo-body-row label,
        .blockinfo-miner label {
            float: left;
            color: #888;
        }

        .blockinfo-body-row span,
        .blockinfo-miner hash {
            float: right;
        }

        .blockinfo-miner {
            clear: both;
            border-top: 1px solid #D9DEE4;
            padding: 1em;
            overflow: auto;
        }

        .blockinfo-transactions {
            border: 1px solid #D9DEE4;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            padding: 1em;
            background: white;
        }

        .blockinfo-transaction-header-row {
            display: table-row;
        }

        .blockinfo-transaction-header-row h3 {
            display: table-cell;
        }

        .blockinfo-transaction-header-row h3:last-child {
            text-align: right;
        }

        .blockinfo-transaction-row {
            display: table-row;
        }

        .blockinfo-transaction-row > * {
            display: table-cell;
            padding: 0.75em 1em 0 0;
            white-space: nowrap;
        }

        .blockinfo-transaction-row:nth-child(2) > * {
            padding-top: 0.5em;
        }

        .blockinfo-transaction-row > span {
            padding-right: 0;
            width: 100%;
            text-align: right;
        }

        .no-transactions {
            text-align: center;
            text-transform: uppercase;
            color: #AAA;
        }

        #blocklist-wrapper {
            max-width: 950px;
            margin: 4em auto 2em auto;
            padding: 0 20px;
        }

        #blocklist-wrapper h2 {
            font-weight: normal;
            text-transform: uppercase;
            margin-bottom: 0.2em;
        }

        #blocklist {
            display: table;
            border-spacing: 0 8px;
            width: 100%;
        }

        .blocklist-block {
            display: table-row;
            background: #D6D6D6;
            background: #F0F0F0;
        }

        a.blocklist-cell::after {
            position: absolute;
            left: 20%;
            bottom: 10px;
            width: 60%;
            content: "";
            border-bottom: 1px dotted;
        }

        a.blocklist-cell:hover::after,
        a.blocklist-cell:focus::after {
            border-bottom-style: solid;
        }

        .blocklist-cell {
            display: table-cell;
            padding: 0.6em 1em;
            white-space: nowrap;
            border-top: 1px solid #D9DEE4;
            border-bottom: 1px solid #D9DEE4;
        }
        .blocklist-cell:first-child {
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
            border-left: 1px solid #D9DEE4;
        }
        .blocklist-cell:last-child {
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
            border-right: 1px solid #D9DEE4;
        }

        .blocklist-loader {
            width: 34px;
            height: 30px;

            margin: auto;
            animation: sk-rotateplane 1.2s infinite ease-in-out;
        }

        .blocklist-loader-text {
            text-align: center;
            margin-bottom: 0;
        }

        @keyframes sk-rotateplane {
            0%   { transform: perspective(120px) rotateX(0deg) rotateY(0deg); }
            50%  { transform: perspective(120px) rotateX(-180.1deg) rotateY(0deg); }
            100% { transform: perspective(120px) rotateX(-180deg) rotateY(-179.9deg); }
        }

        .ellipsis {
            text-overflow: ellipsis;
            overflow: hidden;
            width: 100%;
            max-width: 1px; /* enables the correct overflow behaviour */
        }

        footer {
            text-align: center;
            font-size: 14px;
            color: #AAA;
            padding: 1em;
        }
        footer a {
            color: #888;
        }
    </style>

    <script type="text/javascript" src="https://cdn.nimiq.com/core/nimiq.js"></script>
    <script>
        function _onConsensusEstablished() {
            document.getElementById('targetHeight').style.display = "none";
            $status.innerText = 'consensus established';
            $status.classList.add('consensus-established');
            document.getElementById('search-submit').removeAttribute('disabled');
            document.getElementById('search-submit').removeAttribute('title');

            _buildListOfLatestBlocks();

            if(!window.onhashchange) {
                window.onhashchange = _onHashChange;
                _onHashChange();
            }
        }

        function _onConsensusLost() {
            console.error('Consensus lost');
            $status.innerText = 'consensus lost';
            $status.classList.remove('consensus-established', 'synchronizing');
        }

        function _onHeadChanged() {
            var height = $.blockchain.height;
            document.getElementById('height').innerText = '#' + height;

            if(blocklistBuilt) {
                _getBlockInfo($.blockchain.headHash, function(blockInfo) {
                    _addBlockToListOfLatestBlocks(blockInfo);
                });
            }
        }

        function _onPeersChanged() {
            document.getElementById('monitor').setAttribute('title', 'Connected to ' + $.network.peerCount + ' peers');
        }

        Nimiq.init(function($) {
            $status.innerText = 'synchronizing';
            $status.classList.add('synchronizing');

            window.$ = $;

            $.consensus.on('syncing', function(targetHeight) {
                document.getElementById('targetHeight').innerText = "/" + targetHeight;
            });
            $.consensus.on('established', _onConsensusEstablished);
            $.consensus.on('lost', _onConsensusLost);

            $.blockchain.on('head-changed', _onHeadChanged);
            _onHeadChanged();

            $.network.on('peers-changed', _onPeersChanged);

            $.network.connect();
        }, function(error) {
            console.error(error);
            alert(error);
        });

        // Dummy object to prevent JS errors
        window.$ = {
            consensus: {
                established: false
            }
        };
    </script>
    <script src="vendor/tmpl.min.js"></script>
</head>
<body>
    <header>
        <h1>
            <a href="#" onclick="_linkClicked(this, true);">
                <span class="nimiq-logo">
                    <svg fill="#F6AE2D" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
                </span>
                NIMIQ.WATCH
            </a>
        </h1>
        <a href="#" onclick="_linkClicked(this, true);">Search</a>
        <a href="#about" onclick="_linkClicked(this, true);">What is this?</a>
        <span id="monitor" title="Connected to 0 peers">
            <strong>Status:</strong>
            <span id="status" class="not-connected">not connected</span> @ <span id="height"><em>loading</em></span><span id="targetHeight"></span>
        </span>
    </header>

    <div id="search">
        <h1>Search accounts and blocks:</h1>

        <form action="#search" method="GET" id="search-form">
            <input type="text" id="search-input" placeholder="account address, HEX block hash or block height" onfocus="this.select();" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <input type="submit" id="search-submit" value="go" disabled="" title="Consensus not established">
            <span class="detection">Format detected: <span id="hash-format"><em>none</em></span></span>
        </form>
    </div>

    <div id="infobox">
    </div>

    <div id="blocklist-wrapper">
        <h2>Latest blocks</h2>
        <div id="blocklist">
            <div class="blocklist-block">
                <div class="blocklist-cell">
                    <div class="blocklist-loader">
                        <svg fill="#F6AE2D" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
                    </div>
                    <p class="blocklist-loader-text">Please wait while the blockchain is being synchronized. You can track the progress in the top right corner of the screen.</p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        This web application is built on top of the <a target="_blank" href="https://nimiq.com">Nimiq Blockchain</a>.
        <a target="_blank" href="https://github.com/sisou/nimiq-watch">View Source Code on Github.</a>
    </footer>

    <script type="text/x-tmpl" id="template-block-info">
        <h2>Block Info</h2>
        <div class="blockinfo-header">
            <div class="height">
                <h3>Height</h3>
                <span>#{%=o.height%}</span>
            </div>
            <div class="hash">
                <h3>Hash</h3>
                <hash>{%=o.hash%}</hash>
            </div>
        </div>
        <div class="blockinfo-body">
            <div class="blockinfo-body-left">
                <div class="blockinfo-body-row">
                    <label>Transactions </label>
                    <span>{%=o.transactionCount%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Transaction Value </label>
                    <span><img src="icons/nimiq_blue.svg"> {%=_formatBalance(Nimiq.Policy.satoshisToCoins(o.transactionValue))%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Difficulty </label>
                    <span>{%=(Math.round(o.difficulty * 100) / 100)%}</span>
                </div>
            </div>
            <div class="blockinfo-body-right">
                <div class="blockinfo-body-row">
                    <label>Timestamp </label>
                    <span>{% var date = new Date(o.timestamp * 1000); print(date.toLocaleString()); %}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Size </label>
                    <span>{%=o.serializedSize%} Bytes</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Nonce </label>
                    <span>{%=o.nonce%}</span>
                </div>
            </div>
            <div class="blockinfo-miner">
                <label>Mined by </label>
                <hash><a href="#{%=o.minerAddr%}" onclick="_linkClicked(this);">{%=o.minerAddr%}</a></hash>
                <!--
                <label>Previous Block </label>
                <hash>{%=o.prevHash%}</hash>
                -->
            </div>
        </div>
        <div class="blockinfo-transactions">
            {% if(o.transactionCount) { %}
                <div class="blockinfo-transaction-header-row">
                    <h3>Sender</h3>
                    <h3>Receiver</h3>
                    <h3>Value</h3>
                </div>
                {% for(var i = 0; i < o.transactions.length; i++) { %}
                    <div class="blockinfo-transaction-row">
                        <hash id="{% var elementId = 'sender-address-' + i; _getAndWriteSenderAddressHash(o.transactions[i], elementId); print(elementId); %}"></hash>
                        <hash><a href="#{%=o.transactions[i].recipientAddr.toHex()%}" onclick="_linkClicked(this);">{%=o.transactions[i].recipientAddr.toHex()%}</a></hash>
                        <span><img src="icons/nimiq_blue.svg"> {%=_formatBalance(Nimiq.Policy.satoshisToCoins(o.transactions[i].value))%}</span>
                    </div>
                {% } %}
            {% } else { %}
                <div class="no-transactions">No transactions</div>
            {% } %}
        </div>
    </script>

    <script type="text/x-tmpl" id="template-account-info">
        <div class="accountinfo-wrapper">
            <h2>Account Info</h2>
            <div class="blockinfo-header">
                <div class="hash">
                    <h3>Address</h3>
                    <hash>{%=o.hash%}</hash>
                </div>
            </div>
            <div class="blockinfo-body">
                <div class="blockinfo-body-row">
                    <label>Balance </label>
                    <span><img src="icons/nimiq_blue.svg"> {%=_formatBalance(Nimiq.Policy.satoshisToCoins(o.balance))%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Nonce </label>
                    <span>{%=o.nonce%}</span>
                </div>
            </div>
        </div>
    </script>

    <script type="text/x-tmpl" id="template-blocklist-block">
        <a href="#{%=o.height%}" class="blocklist-cell" onclick="_linkClicked(this);">
            #{%=o.height%}
        </a>
        <div class="blocklist-cell">
            {% var time = new Date(o.timestamp * 1000); print(time.toLocaleTimeString()); %}
        </div>
        <div class="blocklist-cell">
            {%=o.transactionCount%} {% if(o.transactionCount === 1) print('transaction'); else print('transactions'); %}
        </div>
        <div class="blocklist-cell ellipsis">
            found by <hash><a href="#{%=o.minerAddr%}" onclick="_linkClicked(this);">{%=o.minerAddr%}</a></hash>
        </div>
        <div class="blocklist-cell">
            {%=o.serializedSize%} Bytes
        </div>
    </script>

    <script type="text/x-tmpl" id="template-about">
        <div class="about-wrapper">
            <h2>What is this?</h2>
            <p>
                This website is a blockchain explorer for the new <a href="https://nimiq.com" target="_blank">Nimiq blockchain project</a>.
            </p>
            <p>
                Because the Nimiq blockchain lives in your browser, this website works without a server. All necessary information is
                present in the blockchain, loaded in this browser.
            </p>
            <p>
                The source code for this website is open source and available at
                <a href="https://github.com/sisou/nimiq-watch" target="_blank">https://github.com/sisou/nimiq-watch</a>.
            </p>
            <p>
                To learn more about the Nimiq blockchain, visit the
                <a href="https://nimiq.com"                            target="_blank">homepage</a>,
                check out @nimiqnetwork on
                <a href="https://twitter.com/nimiqnetwork"             target="_blank">Twitter</a> or
                <a href="https://medium.com/nimiq-network"             target="_blank">Medium</a> and join the
                <a href="https://nimiq-slackin.herokuapp.com/"         target="_blank">Slack</a> and
                <a href="https://t.me/joinchat/AAAAAEJW-ozFwo7Er9jpHw" target="_blank">Telegram</a> channels.
            </p>
        </div>
    </script>

    <script>
        var accountHashRegExp = new RegExp('^[A-Fa-f0-9]{40}$'),
            blockHashRegExp   = new RegExp('^[A-Fa-f0-9]{64}$');

        var tmpl = {
            blocklistBlock: tmpl('template-blocklist-block'),
            blockInfo:      tmpl('template-block-info'),
            accountInfo:    tmpl('template-account-info'),
            about:          tmpl('template-about')
        };

        var $infobox     = document.getElementById('infobox'),
            $searchInput = document.getElementById('search-input'),
            $status      = document.getElementById('status');

        var directNavigationTargets = ['#about'];

        function _detectHashFormat(value) {
            if(accountHashRegExp.test(value)) {
                return "Account Address";
            }
            else if(blockHashRegExp.test(value) && value[0] === "0" && value[1] === "0") {
                return "Block Hash";
            }
            else if(value.match(/^[0-9]*$/) && parseInt(value)) {
                return "Block Number";
            }
        }

        function _formatBalance(value) {
            // If the value has no decimal places below 0.01, display 0 decimals
            if(parseFloat(value.toFixed(2)) === value) {
                return value.toFixed(2);
            }
            // Otherwise, all required decimals will be displayed automatically
            else return value;
        }

        function _getBlockInfo(hash, callback) {
            if(typeof hash === "string") {
                hash = Nimiq.Hash.fromHex(hash);
            }

            $.blockchain.getBlock(hash).then(function(block) {
                if(!block) {
                    callback(null);
                    return;
                }

                block.hash().then(function(hash) {
                    callback({
                        hash:             hash.toHex(),
                        height:           block.height,
                        timestamp:        block.timestamp,
                        difficulty:       block.difficulty,
                        serializedSize:   block.serializedSize,
                        minerAddr:        block.minerAddr.toHex(),
                        transactionCount: block.transactionCount,
                        transactions:     block.transactions,
                        transactionValue: block.transactions.reduce(function(acc, tx) { return tx.value + acc; }, 0),
                        prevHash:         block.prevHash.toHex(),
                        nonce:            block.nonce
                    });
                });
            });
        }

        function _getAndWriteSenderAddressHash(tx, elementId) {
            tx.getSenderAddr().then(function(address) {
                document.getElementById(elementId).innerHTML = '<a href="#' + address.toHex() + '" onclick="_linkClicked(this);">' + address.toHex() + '</a>';
            });
        }

        var blocklistBuilt = false;
        var latestBlocks = [];

        function _buildListOfLatestBlocks() {
            if(blocklistBuilt !== false) return;
            blocklistBuilt = null;

            var _accumulateBlocks = function(blockInfo) {
                latestBlocks.push(blockInfo);

                if(latestBlocks.length === 20) {
                    latestBlocks.sort(function(a, b) {
                        if(a.height < b.height) return -1;
                        else return 1;
                    });

                    blocklistNode.removeChild(blocklistNode.getElementsByTagName('div')[0]);

                    for(var i = 0; i < latestBlocks.length; i++ ) {
                        _addBlockToListOfLatestBlocks(latestBlocks[i]);
                    }

                    latestBlocks = null;
                    blocklistBuilt = true;
                }
            };

            var hashes = $.blockchain.path.slice(-20);

            // Query all blocks' info
            for(var i = 0; i < hashes.length; i++) {
                _getBlockInfo(hashes[i], _accumulateBlocks);
            }
        }

        var blocklistNode = document.getElementById('blocklist');

        function _addBlockToListOfLatestBlocks(blockInfo) {
            var item = document.createElement('div');
            item.classList.add('blocklist-block');

            item.innerHTML = tmpl.blocklistBlock(blockInfo);

            blocklistNode.insertBefore(item, blocklistNode.firstChild);
        }

        function _onHashChange(e) {
            var value = window.location.hash;

            // Remove leading '#'
            if(value[0] === "#") value = value.substring(1);

            if(value === "") {
                // Display homepage
                $infobox.innerText = "";
                $searchInput.value = "";
                $searchInput.focus();
            }
            else if(value === "about") {
                $infobox.innerHTML = tmpl.about();
                window.scrollTo(0, $infobox.offsetTop - 100);
            }
            else {
                var format = _detectHashFormat(value);

                $searchInput.value = value;

                switch(format) {
                    case "Account Address":
                        $.accounts.getBalance(Nimiq.Address.fromHex(value)).then(function(balance) {
                            var accountInfo = {
                                hash: value,
                                balance: balance.value,
                                nonce: balance.nonce
                            };

                            $infobox.innerHTML = tmpl.accountInfo(accountInfo);
                            window.scrollTo(0, $infobox.offsetTop - 100);
                        });
                        break;
                    case "Block Hash":
                        _getBlockInfo(value, function(blockInfo) {
                            if(!blockInfo) {
                                alert("That block cannot be found. It my be out of reach due to the temporary checkpoint solution. Lowest possible block: " + $.blockchain.path[0].toHex());
                                return;
                            }

                            $infobox.innerHTML = tmpl.blockInfo(blockInfo);
                            window.scrollTo(0, $infobox.offsetTop - 100);
                        });
                        break;
                    case "Block Number":
                        var currentHeight = $.blockchain.head.height;
                        var pathIndex     = value - currentHeight - 1; // Should be a negative number

                        if(pathIndex < -$.blockchain.path.length) {
                            alert("That block is out of reach due to the temporary checkpoint solution. Lowest possible block: " + $.blockchain.path[0].toHex());
                            return;
                        }
                        if(pathIndex > -1) {
                            alert("That block has not been mined yet.");
                            return;
                        }

                        var blockHash = $.blockchain.path.slice(pathIndex)[0];

                        _getBlockInfo(blockHash, function(blockInfo) {
                            if(!blockInfo) {
                                alert("Cannot find block.");
                                return;
                            }
                            // console.log(blockInfo);

                            $infobox.innerHTML = tmpl.blockInfo(blockInfo);
                            window.scrollTo(0, $infobox.offsetTop - 100);
                        });
                        break;
                    default:
                        alert("Format cannot be detected.");
                }
            }
        }

        $searchInput.addEventListener('input', function(e) {
            document.getElementById('hash-format').innerHTML = _detectHashFormat(this.value) || "<em>none</em>";
        });

        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();

            if(!$.consensus.established) return;

            var value = $searchInput.value;

            if(window.location.hash === "#" + value) {
                // The hashchange event does not trigger if the hash does not change
                // Thus we manually trigger the function
                window.onhashchange();
            }

            window.location.hash = "#" + value;
        });

        function _linkClicked(self, skipReadyCheck) {
            if(!$.consensus.established) {
                if(!skipReadyCheck) {
                    return;
                }
                else {
                    window.location.hash = self.hash;
                    _onHashChange();
                    return;
                }
            }

            if(window.location.hash === self.hash) {
                console.log("_linkClicked triggered");
                _onHashChange();
            }
        }

        $searchInput.focus();
        if(directNavigationTargets.indexOf(window.location.hash) > -1) _onHashChange();
    </script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-101611099-1', 'auto');
        ga('send', 'pageview');
    </script>
</body>
</html>
